#cloud-config
package_upgrade: false

write_files:
  - path: "/startwm.sh"
    content: |
      #!/bin/sh
      if [ -r /etc/default/locale ]; then
        . /etc/default/locale
        export LANG LANGUAGE
      fi
      # Start xfce4
      startxfce4
  - path: "/ldap.conf"
    content: |
      # The distinguished name of the search base.
      base LDAP_BASE_DN

      # Restrict users to those in the securioty group of this DSG
      filter LDAP_FILTER

      # Another way to specify your LDAP server is to provide an
      uri ldap://AD_DC_NAME_LOWER.DOMAIN_LOWER:389

      # The LDAP version to use (defaults to 3
      # if supported by client library)
      ldap_version 3

      # The distinguished name to bind to the server with
      # if the effective user ID is root. Password is
      # stored in /etc/ldap.secret (mode 600)
      rootbinddn LDAP_BIND_DN

      # Do not hash the password at all; presume
      # the directory server will do it, if
      # necessary. This is the default.
      pam_password md5
  - path: "/krb5.conf"
    content: |
      [libdefaults]
        default_realm = DOMAIN_UPPER

      # The following krb5.conf variables are only for MIT Kerberos.
        krb4_config = /etc/krb.conf
        krb4_realms = /etc/krb.realms
        kdc_timesync = 1
        ccache_type = 4
        forwardable = true
        proxiable = true

      # The following libdefaults parameters are only for Heimdal Kerberos.
        v4_instance_resolve = false
        v4_name_convert = {
          host = {
            rcmd = host
            ftp = ftp
          }
          plain = {
            something = something-else
          }
        }
        fcc-mit-ticketflags = true

      [realms]
          DOMAIN_UPPER = {
              kdc = AD_DC_NAME_UPPER.DOMAIN_UPPER:88
              admin_server = AD_DC_NAME_UPPER.DOMAIN_UPPER
              default_domain = DOMAIN_UPPER
              }

      [domain_realm]
            .DOMAIN_LOWER = DOMAIN_UPPER
            DOMAIN_LOWER = DOMAIN_UPPER

      [login]
        krb4_convert = true
        krb4_get_tickets = false
  - path: "/active_directory_step01_pre"
    content: |
      #!/bin/sh
      # Set up Active Directory
      # -----------------------
      echo "Setting up Active Directory..."
      # Ensure that sssd is running
      echo "Ensuring that sssd is running"
      systemctl status sssd.service
      # Add information to hosts file
      echo "Setting hostname"
      echo "MACHINENAME" > /etc/hostname
      cat /etc/hostname
      echo "Adding MACHINENAME [$(hostname -I)] to /etc/hosts"
      HOST_INFORMATION="$(hostname -I) MACHINENAME MACHINENAME.DOMAIN_LOWER"
      sed -i "/127.0.0.1/ a $HOST_INFORMATION" /etc/hosts
      cat /etc/hosts
      # Set timezone
      echo "Setting timezone"
      timedatectl set-timezone Europe/London
      # Create a default sssd.conf file
      echo "Creating sssd config"
      cp /usr/share/doc/sssd-common/examples/sssd-example.conf /etc/sssd/sssd.conf
      cat /etc/sssd/sssd.conf
      # Edit LDAP config
      echo "Creating LDAP config"
      mv /ldap.conf /etc/ldap.conf
      cat /etc/ldap.conf
      # Store LDAP secret
      echo "Storing LDAP secret"
      echo "LDAP_SECRET_PLAINTEXT" > /etc/ldap.secret
      chmod 0600 /etc/ldap.secret
      # Edit Kerberos config
      echo "Updating Kerberos config"
      mv /krb5.conf /etc/krb5.conf
      cat /etc/krb5.conf
  - path: "/active_directory_step02_realm_join"
    content: |
      # Join the VM to the domain
      echo "Joining VM to the domain"
      cat /etc/ldap.secret | realm join --verbose -U LDAP_USER DOMAIN_LOWER --install=/
  - path: "/active_directory_step03_update_sssd"
    content: |
      # Check the sssd.conf file
      echo "Updating sssd settings"
      sed -i -E 's/(use_fully_qualified_names = ).*/\1False/' /etc/sssd/sssd.conf
      sed -i -E 's|(fallback_homedir = ).*|\1/home/%u|' /etc/sssd/sssd.conf
      sed -i -E 's/(access_provider = ).*/\1simple/' /etc/sssd/sssd.conf
      cat /etc/sssd/sssd.conf
      # Restart the sssd daemon
      echo "Restarting sssd"
      systemctl restart sssd
  - path: "/active_directory_step04_update_pam"
    content: |
      # Edit the pam session configuration file
      echo "Updating PAM configuration"
      PAM_INFORMATION="session required|pam_mkhomedir.so|skel=/etc/skel/|umask=0022"
      sed "/pam_unix/ a $PAM_INFORMATION" /etc/pam.d/common-session | tr "|" "\t" > common-session
      mv common-session /etc/pam.d/common-session
      cat /etc/pam.d/common-session
  - path: "/etc/pip.conf"
    content: |
      # Add the PyPI mirror to our global settings
      [global]
      index = http://PYPI_MIRROR_IP:3128
      index-url = http://PYPI_MIRROR_IP:3128/simple
      trusted-host = PYPI_MIRROR_IP
  - path: "/Rprofile.site"
    content: |
      ## Add the CRAN mirror to our global settings
      local({
          r <- getOption("repos")
          r["CRAN"] <- "http://CRAN_MIRROR_IP"
          options(repos = r)
      })
  - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/keyboards.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="keyboards" version="1.0">
        <property name="Default" type="empty">
          <property name="Numlock" type="bool" value="false"/>
        </property>
      </channel>
  - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/thunar.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="thunar" version="1.0">
        <property name="last-view" type="string" value="ThunarIconView"/>
        <property name="last-icon-view-zoom-level" type="string" value="THUNAR_ZOOM_LEVEL_NORMAL"/>
      </channel>
  - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-appfinder.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfce4-appfinder" version="1.0">
        <property name="last" type="empty">
          <property name="window-height" type="int" value="400"/>
          <property name="window-width" type="int" value="400"/>
          <property name="pane-position" type="int" value="180"/>
        </property>
      </channel>
 - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfce4-desktop" version="1.0">
        <property name="backdrop" type="empty">
          <property name="screen0" type="empty">
            <property name="monitor0" type="empty">
              <property name="workspace0" type="empty">
                <property name="color-style" type="int" value="0"/>
                <property name="image-style" type="int" value="5"/>
                <property name="last-image" type="string" value="/usr/share/backgrounds/xfce/xfce-teal.jpg"/>
              </property>
              <property name="workspace1" type="empty">
                <property name="color-style" type="int" value="0"/>
                <property name="image-style" type="int" value="5"/>
                <property name="last-image" type="string" value="/usr/share/backgrounds/xfce/xfce-teal.jpg"/>
              </property>
              <property name="workspace2" type="empty">
                <property name="color-style" type="int" value="0"/>
                <property name="image-style" type="int" value="5"/>
                <property name="last-image" type="string" value="/usr/share/backgrounds/xfce/xfce-teal.jpg"/>
              </property>
              <property name="workspace3" type="empty">
                <property name="color-style" type="int" value="0"/>
                <property name="image-style" type="int" value="5"/>
                <property name="last-image" type="string" value="/usr/share/backgrounds/xfce/xfce-teal.jpg"/>
              </property>
            </property>
          </property>
        </property>
      </channel>
 - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-keyboard-shortcuts.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfce4-keyboard-shortcuts" version="1.0">
        <property name="commands" type="empty">
          <property name="default" type="empty">
            <property name="&lt;Alt&gt;F1" type="empty"/>
            <property name="&lt;Alt&gt;F2" type="empty">
              <property name="startup-notify" type="empty"/>
            </property>
            <property name="&lt;Alt&gt;F3" type="empty">
              <property name="startup-notify" type="empty"/>
            </property>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Delete" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;l" type="empty"/>
            <property name="XF86Display" type="empty"/>
            <property name="&lt;Super&gt;p" type="empty"/>
            <property name="&lt;Primary&gt;Escape" type="empty"/>
            <property name="XF86WWW" type="empty"/>
            <property name="XF86Mail" type="empty"/>
          </property>
          <property name="custom" type="empty">
            <property name="&lt;Alt&gt;F3" type="string" value="xfce4-appfinder">
              <property name="startup-notify" type="bool" value="true"/>
            </property>
            <property name="&lt;Alt&gt;F1" type="string" value="xfce4-popup-applicationsmenu"/>
            <property name="&lt;Alt&gt;F2" type="string" value="xfce4-appfinder --collapsed">
              <property name="startup-notify" type="bool" value="true"/>
            </property>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Delete" type="string" value="xflock4"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;l" type="string" value="xflock4"/>
            <property name="XF86Mail" type="string" value="exo-open --launch MailReader"/>
            <property name="XF86Display" type="string" value="xfce4-display-settings --minimal"/>
            <property name="XF86WWW" type="string" value="exo-open --launch WebBrowser"/>
            <property name="&lt;Super&gt;p" type="string" value="xfce4-display-settings --minimal"/>
            <property name="&lt;Primary&gt;Escape" type="string" value="xfdesktop --menu"/>
            <property name="override" type="bool" value="true"/>
          </property>
        </property>
        <property name="xfwm4" type="empty">
          <property name="default" type="empty">
            <property name="&lt;Alt&gt;Insert" type="empty"/>
            <property name="Escape" type="empty"/>
            <property name="Left" type="empty"/>
            <property name="Right" type="empty"/>
            <property name="Up" type="empty"/>
            <property name="Down" type="empty"/>
            <property name="&lt;Alt&gt;Tab" type="empty"/>
            <property name="&lt;Alt&gt;&lt;Shift&gt;Tab" type="empty"/>
            <property name="&lt;Alt&gt;Delete" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Down" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Left" type="empty"/>
            <property name="&lt;Shift&gt;&lt;Alt&gt;Page_Down" type="empty"/>
            <property name="&lt;Alt&gt;F4" type="empty"/>
            <property name="&lt;Alt&gt;F6" type="empty"/>
            <property name="&lt;Alt&gt;F7" type="empty"/>
            <property name="&lt;Alt&gt;F8" type="empty"/>
            <property name="&lt;Alt&gt;F9" type="empty"/>
            <property name="&lt;Alt&gt;F10" type="empty"/>
            <property name="&lt;Alt&gt;F11" type="empty"/>
            <property name="&lt;Alt&gt;F12" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Shift&gt;&lt;Alt&gt;Left" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;End" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Home" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Shift&gt;&lt;Alt&gt;Right" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Shift&gt;&lt;Alt&gt;Up" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_1" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_2" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_3" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_4" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_5" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_6" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_7" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_8" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_9" type="empty"/>
            <property name="&lt;Alt&gt;space" type="empty"/>
            <property name="&lt;Shift&gt;&lt;Alt&gt;Page_Up" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Right" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;d" type="empty"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Up" type="empty"/>
            <property name="&lt;Super&gt;Tab" type="empty"/>
            <property name="&lt;Primary&gt;F1" type="empty"/>
            <property name="&lt;Primary&gt;F2" type="empty"/>
            <property name="&lt;Primary&gt;F3" type="empty"/>
            <property name="&lt;Primary&gt;F4" type="empty"/>
            <property name="&lt;Primary&gt;F5" type="empty"/>
            <property name="&lt;Primary&gt;F6" type="empty"/>
            <property name="&lt;Primary&gt;F7" type="empty"/>
            <property name="&lt;Primary&gt;F8" type="empty"/>
            <property name="&lt;Primary&gt;F9" type="empty"/>
            <property name="&lt;Primary&gt;F10" type="empty"/>
            <property name="&lt;Primary&gt;F11" type="empty"/>
            <property name="&lt;Primary&gt;F12" type="empty"/>
          </property>
          <property name="custom" type="empty">
            <property name="Up" type="string" value="up_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_9" type="string" value="move_window_workspace_9_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_8" type="string" value="move_window_workspace_8_key"/>
            <property name="Left" type="string" value="left_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_6" type="string" value="move_window_workspace_6_key"/>
            <property name="&lt;Alt&gt;Insert" type="string" value="add_workspace_key"/>
            <property name="&lt;Alt&gt;Tab" type="string" value="cycle_windows_key"/>
            <property name="&lt;Alt&gt;&lt;Shift&gt;Tab" type="string" value="cycle_reverse_windows_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_7" type="string" value="move_window_workspace_7_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Right" type="string" value="right_workspace_key"/>
            <property name="&lt;Primary&gt;&lt;Shift&gt;&lt;Alt&gt;Right" type="string" value="move_window_right_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;d" type="string" value="show_desktop_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Up" type="string" value="up_workspace_key"/>
            <property name="&lt;Primary&gt;F7" type="string" value="workspace_7_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Home" type="string" value="move_window_prev_workspace_key"/>
            <property name="&lt;Alt&gt;F4" type="string" value="close_window_key"/>
            <property name="&lt;Primary&gt;&lt;Shift&gt;&lt;Alt&gt;Left" type="string" value="move_window_left_key"/>
            <property name="&lt;Alt&gt;F6" type="string" value="stick_window_key"/>
            <property name="&lt;Alt&gt;F10" type="string" value="maximize_window_key"/>
            <property name="&lt;Alt&gt;F12" type="string" value="above_key"/>
            <property name="&lt;Alt&gt;F9" type="string" value="hide_window_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Down" type="string" value="down_workspace_key"/>
            <property name="&lt;Alt&gt;F8" type="string" value="resize_window_key"/>
            <property name="&lt;Super&gt;Tab" type="string" value="switch_window_key"/>
            <property name="Escape" type="string" value="cancel_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;End" type="string" value="move_window_next_workspace_key"/>
            <property name="&lt;Primary&gt;F10" type="string" value="workspace_10_key"/>
            <property name="&lt;Primary&gt;F11" type="string" value="workspace_11_key"/>
            <property name="&lt;Alt&gt;F11" type="string" value="fullscreen_key"/>
            <property name="&lt;Primary&gt;&lt;Shift&gt;&lt;Alt&gt;Up" type="string" value="move_window_up_key"/>
            <property name="Right" type="string" value="right_key"/>
            <property name="Down" type="string" value="down_key"/>
            <property name="&lt;Alt&gt;F7" type="string" value="move_window_key"/>
            <property name="&lt;Shift&gt;&lt;Alt&gt;Page_Down" type="string" value="lower_window_key"/>
            <property name="&lt;Primary&gt;F12" type="string" value="workspace_12_key"/>
            <property name="&lt;Primary&gt;F1" type="string" value="workspace_1_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;Left" type="string" value="left_workspace_key"/>
            <property name="&lt;Primary&gt;F2" type="string" value="workspace_2_key"/>
            <property name="&lt;Primary&gt;F4" type="string" value="workspace_4_key"/>
            <property name="&lt;Primary&gt;F5" type="string" value="workspace_5_key"/>
            <property name="&lt;Primary&gt;F6" type="string" value="workspace_6_key"/>
            <property name="&lt;Alt&gt;space" type="string" value="popup_menu_key"/>
            <property name="&lt;Primary&gt;F8" type="string" value="workspace_8_key"/>
            <property name="&lt;Primary&gt;F9" type="string" value="workspace_9_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_1" type="string" value="move_window_workspace_1_key"/>
            <property name="&lt;Alt&gt;Delete" type="string" value="del_workspace_key"/>
            <property name="&lt;Shift&gt;&lt;Alt&gt;Page_Up" type="string" value="raise_window_key"/>
            <property name="&lt;Primary&gt;F3" type="string" value="workspace_3_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_2" type="string" value="move_window_workspace_2_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_3" type="string" value="move_window_workspace_3_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_4" type="string" value="move_window_workspace_4_key"/>
            <property name="&lt;Primary&gt;&lt;Alt&gt;KP_5" type="string" value="move_window_workspace_5_key"/>
            <property name="override" type="bool" value="true"/>
          </property>
        </property>
        <property name="providers" type="array">
          <value type="string" value="commands"/>
          <value type="string" value="xfwm4"/>
        </property>
      </channel>



      - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfce4-session" version="1.0">
        <property name="general" type="empty">
          <property name="FailsafeSessionName" type="empty"/>
          <property name="SessionName" type="string" value="Default"/>
          <property name="SaveOnExit" type="bool" value="true"/>
        </property>
        <property name="sessions" type="empty">
          <property name="Failsafe" type="empty">
            <property name="IsFailsafe" type="empty"/>
            <property name="Count" type="empty"/>
            <property name="Client0_Command" type="empty"/>
            <property name="Client0_PerScreen" type="empty"/>
            <property name="Client1_Command" type="empty"/>
            <property name="Client1_PerScreen" type="empty"/>
            <property name="Client2_Command" type="empty"/>
            <property name="Client2_PerScreen" type="empty"/>
            <property name="Client3_Command" type="empty"/>
            <property name="Client3_PerScreen" type="empty"/>
            <property name="Client4_Command" type="empty"/>
            <property name="Client4_PerScreen" type="empty"/>
          </property>
        </property>
        <property name="splash" type="empty">
          <property name="Engine" type="empty"/>
        </property>
      </channel>
  - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-panel.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfce4-panel" version="1.0">
        <property name="configver" type="int" value="2"/>
        <property name="panels" type="array">
          <value type="int" value="1"/>
          <value type="int" value="2"/>
          <property name="panel-1" type="empty">
            <property name="position" type="string" value="p=6;x=0;y=0"/>
            <property name="length" type="uint" value="100"/>
            <property name="position-locked" type="bool" value="true"/>
            <property name="size" type="uint" value="30"/>
            <property name="plugin-ids" type="array">
              <value type="int" value="1"/>
              <value type="int" value="3"/>
              <value type="int" value="15"/>
              <value type="int" value="4"/>
              <value type="int" value="5"/>
              <value type="int" value="6"/>
              <value type="int" value="2"/>
            </property>
          </property>
          <property name="panel-2" type="empty">
            <property name="position" type="string" value="p=10;x=0;y=0"/>
            <property name="position-locked" type="bool" value="true"/>
            <property name="plugin-ids" type="array">
              <value type="int" value="10"/>
              <value type="int" value="12"/>
              <value type="int" value="9"/>
              <value type="int" value="8"/>
              <value type="int" value="16"/>
              <value type="int" value="17"/>
              <value type="int" value="18"/>
              <value type="int" value="19"/>
              <value type="int" value="20"/>
              <value type="int" value="13"/>
              <value type="int" value="7"/>
            </property>
          </property>
        </property>
        <property name="plugins" type="empty">
          <property name="plugin-1" type="string" value="applicationsmenu"/>
          <property name="plugin-2" type="string" value="actions"/>
          <property name="plugin-3" type="string" value="tasklist"/>
          <property name="plugin-15" type="string" value="separator">
            <property name="expand" type="bool" value="true"/>
            <property name="style" type="uint" value="0"/>
          </property>
          <property name="plugin-4" type="string" value="pager"/>
          <property name="plugin-5" type="string" value="clock"/>
          <property name="plugin-6" type="string" value="systray"/>
          <property name="plugin-7" type="string" value="showdesktop"/>
          <property name="plugin-8" type="string" value="separator"/>
          <property name="plugin-9" type="string" value="launcher">
            <property name="items" type="array">
              <value type="string" value="15573939451.desktop"/>
            </property>
          </property>
          <property name="plugin-10" type="string" value="launcher">
            <property name="items" type="array">
              <value type="string" value="15573939452.desktop"/>
            </property>
          </property>
          <property name="plugin-12" type="string" value="launcher">
            <property name="items" type="array">
              <value type="string" value="15573939454.desktop"/>
            </property>
          </property>
          <property name="plugin-13" type="string" value="separator"/>
          <property name="plugin-16" type="string" value="launcher">
            <property name="items" type="array">
              <value type="string" value="15602591101.desktop"/>
            </property>
          </property>
          <property name="plugin-17" type="string" value="launcher">
            <property name="items" type="array">
              <value type="string" value="15602591342.desktop"/>
            </property>
          </property>
          <property name="plugin-18" type="string" value="launcher">
            <property name="items" type="array">
              <value type="string" value="15602591513.desktop"/>
            </property>
          </property>
          <property name="plugin-19" type="string" value="launcher">
            <property name="items" type="array">
              <value type="string" value="15602591664.desktop"/>
            </property>
          </property>
          <property name="plugin-20" type="string" value="launcher">
            <property name="items" type="array">
              <value type="string" value="15602591915.desktop"/>
            </property>
          </property>
        </property>
      </channel>
  - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfce4-session" version="1.0">
        <property name="general" type="empty">
          <property name="FailsafeSessionName" type="empty"/>
          <property name="SessionName" type="string" value="Default"/>
          <property name="SaveOnExit" type="bool" value="true"/>
        </property>
        <property name="sessions" type="empty">
          <property name="Failsafe" type="empty">
            <property name="IsFailsafe" type="empty"/>
            <property name="Count" type="empty"/>
            <property name="Client0_Command" type="empty"/>
            <property name="Client0_PerScreen" type="empty"/>
            <property name="Client1_Command" type="empty"/>
            <property name="Client1_PerScreen" type="empty"/>
            <property name="Client2_Command" type="empty"/>
            <property name="Client2_PerScreen" type="empty"/>
            <property name="Client3_Command" type="empty"/>
            <property name="Client3_PerScreen" type="empty"/>
            <property name="Client4_Command" type="empty"/>
            <property name="Client4_PerScreen" type="empty"/>
          </property>
        </property>
        <property name="splash" type="empty">
          <property name="Engine" type="empty"/>
        </property>
      </channel>
  - path: "/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfwm4" version="1.0">
        <property name="general" type="empty">
          <property name="activate_action" type="string" value="bring"/>
          <property name="borderless_maximize" type="bool" value="true"/>
          <property name="box_move" type="bool" value="false"/>
          <property name="box_resize" type="bool" value="false"/>
          <property name="button_layout" type="string" value="O|SHMC"/>
          <property name="button_offset" type="int" value="0"/>
          <property name="button_spacing" type="int" value="0"/>
          <property name="click_to_focus" type="bool" value="true"/>
          <property name="cycle_apps_only" type="bool" value="false"/>
          <property name="cycle_draw_frame" type="bool" value="true"/>
          <property name="cycle_hidden" type="bool" value="true"/>
          <property name="cycle_minimum" type="bool" value="true"/>
          <property name="cycle_preview" type="bool" value="true"/>
          <property name="cycle_tabwin_mode" type="int" value="0"/>
          <property name="cycle_workspaces" type="bool" value="false"/>
          <property name="double_click_action" type="string" value="maximize"/>
          <property name="double_click_distance" type="int" value="5"/>
          <property name="double_click_time" type="int" value="250"/>
          <property name="easy_click" type="string" value="Alt"/>
          <property name="focus_delay" type="int" value="250"/>
          <property name="focus_hint" type="bool" value="true"/>
          <property name="focus_new" type="bool" value="true"/>
          <property name="frame_opacity" type="int" value="100"/>
          <property name="full_width_title" type="bool" value="true"/>
          <property name="horiz_scroll_opacity" type="bool" value="false"/>
          <property name="inactive_opacity" type="int" value="100"/>
          <property name="maximized_offset" type="int" value="0"/>
          <property name="mousewheel_rollup" type="bool" value="true"/>
          <property name="move_opacity" type="int" value="100"/>
          <property name="placement_mode" type="string" value="center"/>
          <property name="placement_ratio" type="int" value="20"/>
          <property name="popup_opacity" type="int" value="100"/>
          <property name="prevent_focus_stealing" type="bool" value="false"/>
          <property name="raise_delay" type="int" value="250"/>
          <property name="raise_on_click" type="bool" value="true"/>
          <property name="raise_on_focus" type="bool" value="false"/>
          <property name="raise_with_any_button" type="bool" value="true"/>
          <property name="repeat_urgent_blink" type="bool" value="false"/>
          <property name="resize_opacity" type="int" value="100"/>
          <property name="scroll_workspaces" type="bool" value="true"/>
          <property name="shadow_delta_height" type="int" value="0"/>
          <property name="shadow_delta_width" type="int" value="0"/>
          <property name="shadow_delta_x" type="int" value="0"/>
          <property name="shadow_delta_y" type="int" value="-3"/>
          <property name="shadow_opacity" type="int" value="50"/>
          <property name="show_app_icon" type="bool" value="false"/>
          <property name="show_dock_shadow" type="bool" value="true"/>
          <property name="show_frame_shadow" type="bool" value="true"/>
          <property name="show_popup_shadow" type="bool" value="false"/>
          <property name="snap_resist" type="bool" value="false"/>
          <property name="snap_to_border" type="bool" value="true"/>
          <property name="snap_to_windows" type="bool" value="false"/>
          <property name="snap_width" type="int" value="10"/>
          <property name="sync_to_vblank" type="bool" value="false"/>
          <property name="theme" type="string" value="Default"/>
          <property name="tile_on_move" type="bool" value="true"/>
          <property name="title_alignment" type="string" value="center"/>
          <property name="title_font" type="string" value="Sans Bold 9"/>
          <property name="title_horizontal_offset" type="int" value="0"/>
          <property name="titleless_maximize" type="bool" value="false"/>
          <property name="title_shadow_active" type="string" value="false"/>
          <property name="title_shadow_inactive" type="string" value="false"/>
          <property name="title_vertical_offset_active" type="int" value="0"/>
          <property name="title_vertical_offset_inactive" type="int" value="0"/>
          <property name="toggle_workspaces" type="bool" value="false"/>
          <property name="unredirect_overlays" type="bool" value="true"/>
          <property name="urgent_blink" type="bool" value="false"/>
          <property name="use_compositing" type="bool" value="true"/>
          <property name="workspace_count" type="int" value="4"/>
          <property name="wrap_cycle" type="bool" value="true"/>
          <property name="wrap_layout" type="bool" value="true"/>
          <property name="wrap_resistance" type="int" value="10"/>
          <property name="wrap_windows" type="bool" value="true"/>
          <property name="wrap_workspaces" type="bool" value="false"/>
          <property name="zoom_desktop" type="bool" value="true"/>
          <property name="workspace_names" type="array">
            <value type="string" value="Workspace 1"/>
            <value type="string" value="Workspace 2"/>
            <value type="string" value="Workspace 3"/>
            <value type="string" value="Workspace 4"/>
          </property>
        </property>
      </channel>
  # - path: "/etc/xdg/xfce4/panel/launcher-16/15602591101.desktop"
  #   content: |
  #     [Desktop Entry]
  #     Name=Atom
  #     Comment=A hackable text editor for the 21st Century.
  #     GenericName=Text Editor
  #     Exec=/opt/atom/atom %F
  #     Icon=atom
  #     Type=Application
  #     StartupNotify=true
  #     Categories=GNOME;GTK;Utility;TextEditor;Development
  #     MimeType=text/plain
  #     X-Desktop-File-Install-Version=0.23
  #     X-XFCE-Source=file:///usr/share/applications/atom.desktop


runcmd:
  # # Setup panel icons
  # - mkdir -p /etc/xdg/xfce4/panel/launcher-10/; cp /usr/share/applications/exo-file-manager.desktop /etc/xdg/xfce4/panel/launcher-10/15573939452.desktop
  # - mkdir -p /etc/xdg/xfce4/panel/launcher-12/; cp /usr/share/applications/xfce4-appfinder.desktop /etc/xdg/xfce4/panel/launcher-12/15573939454.desktop
  # - mkdir -p /etc/xdg/xfce4/panel/launcher-16/; cp /usr/share/applications/atom.desktop /etc/xdg/xfce4/panel/launcher-16/15602591101.desktop
  # - mkdir -p /etc/xdg/xfce4/panel/launcher-17/; cp /usr/share/applications/code.desktop /etc/xdg/xfce4/panel/launcher-17/15602591342.desktop
  # - mkdir -p /etc/xdg/xfce4/panel/launcher-18/; cp /usr/share/applications/rstudio.desktop /etc/xdg/xfce4/panel/launcher-18/15602591513.desktop
  # - mkdir -p /etc/xdg/xfce4/panel/launcher-19/; cp /usr/share/applications/www.octave.org-octave.desktop /etc/xdg/xfce4/panel/launcher-19/15602591664.desktop
  # - mkdir -p /etc/xdg/xfce4/panel/launcher-20/; cp /usr/share/applications/firefox.desktop /etc/xdg/xfce4/panel/launcher-20/15602591915.desktop
  # Disable thinclients_drive folder created by xrdp
  - sed -i "s/allow_channels=true/allow_channels=false/" /etc/xrdp/xrdp.ini
  # ==========================================
  # *** BEGINNING OF DSG-SPECIFIC COMMANDS ***
  # *** END OF DSG-SPECIFIC COMMANDS ***
  # ==========================================
  # Move CRAN mirror config to appropriate locations
  - cp /Rprofile.site /etc/R/Rprofile.site
  - cp /Rprofile.site /anaconda/envs/py27/lib/R/etc/Rprofile.site
  - cp /Rprofile.site /anaconda/envs/py36/lib/R/etc/Rprofile.site
  - cp /Rprofile.site /anaconda/envs/py37/lib/R/etc/Rprofile.site
  # Create shared data folder and grant all users access
  - echo "Creating shared data folder"
  - sudo mkdir /data
  - sudo chmod go+rw /data
  # Make sure that sssd is running
  - echo "Restart sssd service"
  - service sssd restart
  # Set py36 as default environment when launching a new shell
  - echo "Add py36 conda environment setup to global bashrc"
  - echo "conda activate py36" >> /etc/bash.bashrc
  # Disable light-locker which can cause irritating error messages
  - echo "Disable screen lock"
  - echo "Hidden=true" >> /etc/xdg/autostart/light-locker.desktop
  # Set default session to xfce4
  - echo "Set default session to xfce4"
  - mv /startwm.sh /etc/xrdp/startwm.sh
  - chmod 0755 /etc/xrdp/startwm.sh
  - echo xfce4-session > ~USERNAME/.xsession
  # Set default terminal for xfce
  - echo "Set default xfce terminal"
  - sed -i -E 's/(TerminalEmulator=).*/\1xfce4-terminal/' /etc/xdg/xfce4/helpers.rc
  # Ensure that user owns their home directory
  - echo "Ensure that user owns their home directory"
  - chown -R USERNAME ~USERNAME
  # Restart xrdp to reflect changes made above
  - echo "Restart xrdp"
  - service xrdp restart
  # Add execute permission to the Active Directory set up scripts
  - sudo chmod +x /active_directory_step01_pre
  - sudo chmod +x /active_directory_step02_realm_join
  - sudo chmod +x /active_directory_step03_update_sssd
  - sudo chmod +x /active_directory_step04_update_pam
  # Run the Active Directory set up scripts
  - sudo /active_directory_step01_pre
  - sudo /active_directory_step02_realm_join
  - sudo /active_directory_step03_update_sssd
  - sudo /active_directory_step04_update_pam
  # Remove the Active Directory set up scripts (as these contain secrets and are world readable
  - sudo rm /active_directory_step01_pre
  - sudo rm /active_directory_step02_realm_join
  - sudo rm /active_directory_step03_update_sssd
  - sudo rm /active_directory_step04_update_pam
  # Shutdown so that we can tell when the job has finished by polling the VM state
  - shutdown -P now

